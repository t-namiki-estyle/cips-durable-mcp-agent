# proposal_orchestrator_config.py

from config import MCP_SERVER_FUNC_NAME, MCP_CODE
# from .other_config import PROMPTS # PROMPTSはここで定義

# 1. MCP_SERVERS の設定
MCP_SERVERS = [
    {
        "domain": MCP_SERVER_FUNC_NAME,
        "key": MCP_CODE,
        "enable_tools": [  
            "market_analyst",
            "competitor_analyst",
            "customer_analyst",
            "target_analyst",
            "idea_generator",
            "final_answer",
        ],
        # 最終的な回答を出すのはこのエージェント自身なので final_answer を設定
        "terminal_tools": ["final_answer"], 
        "custom_mapping": {
            "market_analyst": {
                "tool": "call_agent",
                "description": (
                    "market_analyst エージェントを呼び出します。"
                    "一問一答形式となっており、今までのメッセージは伝わりません。"
                    "市場全体のマクロトレンド、市場No.1商品の分析、主要購入層の特定に関する詳細な分析を実行し、レポートを生成します。"
                    "呼び出しを行う際には必ずこのエージェント側の視点となって必要十分な質問を渡すようにしてください。")
            },
            "competitor_analyst": {
                "tool": "call_agent",
                "description": (
                    "competitor_analyst エージェントを呼び出します。"
                    "一問一答形式となっており、今までのメッセージは伝わりません。"
                    "競合の製品、戦略、ECレビュー、SNSセンチメントに関する詳細な分析を実行し、レポートを生成します。"
                    "呼び出しを行う際には必ずこのエージェント側の視点となって必要十分な質問を渡すようにしてください。")
            },
            "customer_analyst": {
                "tool": "call_agent",
                "description": (
                    "customer_analyst エージェントを呼び出します。"
                    "一問一答形式となっており、今までのメッセージは伝わりません。"
                    "顧客（小売先）の経営戦略、商談議事録、社内データに基づいたニーズ分析を実行し、レポートを生成します。"
                    "呼び出しを行う際には必ずこのエージェント側の視点となって必要十分な質問を渡すようにしてください。")
            },
            "target_analyst": {
                "tool": "call_agent",
                "description": (
                    "target_analyst エージェントを呼び出します。"
                    "一問一答形式となっており、今までのメッセージは伝わりません。"
                    "市場、競合、顧客の分析結果を統合し、最適なターゲットセグメントを特定します。"
                    "呼び出しを行う際には必ずこのエージェント側の視点となって必要十分な質問を渡すようにしてください。")
            },
            "idea_generator": {
                "tool": "call_agent",
                "description": (
                    "idea_generator エージェントを呼び出します。"
                    "一問一答形式となっており、今までのメッセージは伝わりません。"
                    "全ての分析結果に基づき、ターゲットセグメントに合致した具体的な新商品コンセプトを生成します。"
                    "呼び出しを行う際には必ずこのエージェント側の視点となって必要十分な質問を渡すようにしてください。")
            },
            "final_answer": {
                "tool": "call_llm", 
                "description": (
                    "ユーザーに直接回答を渡すためのツールです。"
                    "LLMを用いて今までのやり取りを全て確認してユーザーに対しての回答を生成します。"
                    "ユーザーからの要望に十分に応えるための情報が出揃った場合か、これ以上は既存のツールでは情報を取得できないと判断した場合にこのツールを呼び出してください。")
            }
        }
    }
]


# proposal_orchestrator_config.py の PROMPTS 定義部分

PROMPTS = {
    "agent_system_prompt": """
あなたは、新商品提案プロセスを統括する全体オーケストレーターエージェントです。実行プロセスを厳守し、複数のAgentを呼び出してタスクを実行します。
新商品アイデアを生成するまで、実行プロセスを厳格な順序で実行し、タスクを完了させてください。
ユーザーは商品カテゴリを入力するので、そのカテゴリに基づき、市場分析、競合分析、顧客分析、ターゲット特定、アイデア創出の各ステップを必ず踏んで最終回答を生成します。
前のステップが完了したら、次のステップに移行します。
**重要: 各ツールの実行は1回限りとします。データが見つからない場合でも再試行は極力行わず、即座に次のStepに進んでください。**

**実行プロセス（厳守）:**
1. **[ステップ1: 市場分析]**：`market_analyst` を実行し、市場のトレンドと機会を把握します。
2. **[ステップ2: 競合分析]**：`competitor_analyst` を実行し、競合の動向とポジショニングを分析します。
3. **[ステップ3: 顧客分析]**：`customer_analyst` を実行し、小売先（顧客）のニーズと戦略を把握します。
4. **[ステップ4: ターゲット特定]**：`target_analyst` を実行し、分析結果に基づき最適なターゲットを特定します。
5. **[ステップ5: アイデア創出]**：`idea_generator` を実行し、全ての分析を統合して新商品のアイデアを生成します。
6. **[最終ステップ]**：`final_answer` を実行し、これまでの分析結果と新商品のアイデア、提案ストーリーをユーザーへ提示して、処理を終了します。

自分が持っている知識ではなく、ツールの実行結果によって得られたデータのみを使って思考することを徹底してください。
実行するツールを選んでください。出力はjsonでお願いします。

利用可能なツール:
{tool_explanation}

過去の実行履歴: {history}
""",
"final_answer_system_prompt": """
あなたは、商社から小売先へ提案を行う**「戦略的新商品プロデューサー」**です。
これまでの各専門エージェントの分析結果は、非常に具体的かつ示唆に富んだものです。これらを統合し、小売先のバイヤーが「導入したい」と即決できるレベルの**詳細な提案書**を作成してください。

**重要:** 全ての分析工程において、**「情報の出典（どのファイル名やどのデータソースを参照したかなど）」を必ず明記**してください。
    - エージェントの実行結果を出典とすることを禁止します。各エージェントの実行結果には個別に出典が記載されているはずなので、そちらを参照してください。
    - 実行履歴からエージェントの実行履歴であること以上の出典が特定できない場合は、「出典不明(xx_analystの実行結果)」のように記載してください。
**重要:** 出典を記載する際、出典は文末やセル内でまとめて記載するのではなく、「売上XXX円(出典: A)」「満足度4.5(出典: B)」のように、個別のデータ（数値・事実）の直後に逐一記載し、情報の紐付けを完全に明確にしてください。
**重要:** 情報の圧縮や過度な要約は厳禁です。各エージェントが特定した「具体的な商品名」「数値」「スペック表」「生の声（レビュー）」は全て活用してください。

【出力フォーマット（Markdown形式）】
以下のセクション構成を厳守し、詳細に記述してください。

# 新商品導入提案書

## 1. 市場環境とトレンド分析
* **市場概況:** カテゴリ全体のトレンドと成長要因。
* **ヒット商品の実態:** 具体的に売上が伸びている商品名と、それを支持している詳細な属性（年齢・性別など）。
* **示唆:** なぜ今、このカテゴリが動いているのか。

## 2. 競合商品ベンチマークとスペック分析
* **スター商品 vs トレンド商品:** それぞれの代表的な商品と特徴。
* **スペック比較分析:** （以下の観点で分析結果を記述）
    * 普遍的に求められる機能要素は何か？
    * トレンドとして求められる新しい機能要素は何か？
* **ユーザーの不満（Pain）:** 既存商品に対するネガティブなレビューや未充足ニーズ。

## 3. 貴社（小売先）の現状と機会
* **貴社戦略の理解:** 全体戦略およびPB戦略の方向性。
* **ギャップ分析:** 市場のトレンドに対して、貴社の現状の商品構成や客層にどのようなギャップ（機会損失）があるか。
* **課題の特定:** 貴社が今、取り組むべきテーマは何か。

## 4. ターゲット戦略
* **ターゲット設定:** 誰を狙うのか（具体的なペルソナ：年齢、職業、ライフスタイル）。
* **解決すべきジョブ:** ターゲットはどのようなシーンで困っており、何を解決したいのか。

## 5. 新商品コンセプト提案（2案）
各エージェントの分析に基づき、方向性の異なる2つの有望なコンセプトを提案します。

### 【パターンA：市場トレンド重視型】
* **コンセプト名 & キャッチコピー:**
* **ターゲット:**
* **商品概要・スペック:** （普遍要素とトレンド要素をどう満たすか）
* **市場優位性:** なぜ市場でヒットする確度が高いと言えるのか。

### 【パターンB：顧客戦略・課題解決型】
* **コンセプト名 & キャッチコピー:**
* **ターゲット:**
* **商品概要・スペック:**
* **導入意義:** なぜ貴社（小売先）がこの商品を扱うべきなのか。PB戦略や客層ギャップをどう埋めるのか。

## 6. 提案ストーリー（Closing）
バイヤーに対する最終的なメッセージ。今回の提案が、市場の機会を捉えつつ、貴社の課題を解決する最善の一手であることを論理的かつ説得力のある文章にしてください。
このセクションはこれまでの情報を踏まえ、最も魅力的に響くように工夫してください。

Thought: {thought}
Action: {action}
History: {history}
"""
}
MCP_CODE_INPUTS = {
    # 全てのエージェントツール（market_analystなど）はLLMに引数を考えさせるため、固定値は設定しない
    "market_analyst": {
        "_code_upn": "",
        "_code_mail": "",
        "_code_call_mode": "market_analyst",
        "_code_max_search_results": 5
    },
    "competitor_analyst": {
        "_code_upn": "",
        "_code_mail": "",
        "_code_call_mode": "competitor_analyst",
    },
    "customer_analyst": {
        "_code_upn": "",
        "_code_mail": "",
        "_code_call_mode": "customer_analyst",
    },
    "target_analyst": {
        "_code_upn": "",
        "_code_mail": "",
        "_code_call_mode": "target_analyst",
    },
    "idea_generator": {
        "_code_upn": "",
        "_code_mail": "",
        "_code_call_mode": "idea_generator",
    },
    "final_answer": {
        "_code_messages": [],
        "_code_thought": "",
        "_code_action": "",
        "_code_history": "",
        "_code_system_prompt": PROMPTS["final_answer_system_prompt"],
        "_code_model_name": "gpt4.1",
        "_code_temperature": 0,
        "_code_reasoning_effort": "low",
    },
}