from config import MCP_SERVER_FUNC_NAME, MCP_CODE

ANALYSIS_COLUMNS = [
    "会社正式名称",
    "本社所在地",
    "経営者略歴",
    "役員一覧",
    "オーナー一族の情報",
    "業種",
    "事業の内容",
    "取扱商品・サービス",
    "会社組織情報",
    "事業所一覧",
    "販売エリア",
    "子会社一覧",
    "取引銀行",
    "売上高",
    "税引後当期純利益",
    "総資産",
    "資本金",
    "自己資本比率",
    "従業員数",
    "市場規模",
    "業界トレンド情報",
    "製品トレンド情報",
    "原料トレンド情報",
    "物流トレンド情報",
    "CAGR（業界）",
    "競合一覧",
    "業界シェア",
    "競合優位性",
    "主要顧客一覧",
    "顧客別売上比率",
    "仕入先一覧",
    "仕入先比率",
    "事業領域ごとの売上高",
    "事業領域ごとの売上比率",
    "海外・国内売上高",
    "海外・国内売上比率",
    "訴訟情報",
    "反社リスク",
    "行政処分・罰則履歴",
    "重大法令違反履歴",
    "関税・貿易リスク",
    "政策リスク",
    "経営者関連法規制",
    "外資規制",
    "特許数",
    "特許一覧",
    "経営者年齢",
    "後継者問題の有無",
    "株主一覧",
    #"アクティビスト情報/政策保有/ファンド",
    "沿革",
    "マーケティング施策・体制",
    "物流網情報",
    "海外展開状況・方針",
    "ESG取組状況",
    "伊藤忠取引有無、取引額",
    "商社ビジネスと親和性",
    "アクティビスト情報/政策保有/ファンド",
    "気候変動・自然災害リスク",
    "最新のニュース",
    "技術革新・研究取り組み",
    # "リスク分析",
    # "投資対象評価",
]

MCP_SERVERS = [
    {
        "domain": MCP_SERVER_FUNC_NAME,
        "key": MCP_CODE,
        "enable_tools": [
            # レポート作成
            "create_company_report",
            # I-Research
            "google_search",
            "define",
            "search",
            "update_hypothesis",
            "summarize_history",
        ],
        "terminal_tools": ["create_company_report"],
        "custom_mapping": {
            "summarize_history": {
                "tool": "call_llm",
                "description": (
                    "このツールはシステムの内部処理用に提供されています。"
                    "ユーザー向けの機能は提供しておらず、有用な応答を返すことはありません。"
                    "いかなるユーザーリクエストに対しても呼び出さないでください。"
                )
            },
            "google_search": {
                "tool": "google_search",
                "description": (
                    "クエリを受け取り検索を実施、検索結果を渡す。"
                    "学習済みの最新情報が古くなっている可能性を考慮して広く浅く調査を行うために用いる。"
                    "企業概要のキャッチアップに使用。"
                    "ベンダー／企業名／業界名＋「最新」「動向」「ニュース」「概要」等\n"
                    "表記ゆれ（和英・略称）を織り交ぜ複数クエリを発行"
                )
            },
            "define": {
                "tool": "call_llm",
                "description": (
                    "Webでの情報取得のための専用ツール。"
                    "企業名、法人番号、所在地の企業情報をもとに本格的な調査を開始する際に最初に呼び出す。"
                    "現状の情報を整理してどのような情報をWebを用いて取得するか戦略を考える。"
                )
            },
            "search": {
                "tool": "search",
                "description": (
                    "Webでの情報取得のための専用ツール。"
                    "Google検索APIを利用してWeb検索を行うツール。Webでの詳細調査専用。"
                    "各検索キーワードに関連した詳細な情報を収集するために使用する。"
                )
            },
            "update_hypothesis": {
                "tool": "call_llm",
                "description": (
                    "Webでの情報取得のための専用ツール。"
                    "現状で集まった情報を整理して仮説の更新を行うためのツール。"
                    "調査を継続するべきか否かの判断も行う。"
                )
            }
        }
    }
]

# エージェント、ツールのプロンプト
PROMPTS = {
    "agent_system_prompt": """### あなたの役割
        あなたは伊藤忠商事の投資調査を担当するエキスパートエージェントです。
        引き継ぎ確定済み企業情報をもとに、包括的な投資調査を実行し、意思決定に必要な情報を提供することが使命です。
        ReAct(Reasoning and Acting) パターンで動作し、各ステップでは **論理的思考 (thought)** → **具体的アクション (action)** → **使用するツール (tool)** を明示しながらタスクを進めてください。
        ### 出力形式 (必須)
        すべての回答は、下記の JSON 形式で行ってください。
        ```
        {{ "thought": "ここにあなたの思考プロセスを詳しく書いてください",
        "action": "具体的に何をするのかを端的かつ詳細に書いてください",
        "tool": "利用可能なツールの中から1つ選択してください"
        }}
        ```

        ### 引き継ぎ情報
        - 調査対象企業
        - 法人番号(日本企業の場合のみ)
        - 企業所在地

        ### 調査対象項目
        [
            "会社正式名称",
            "本社所在地",
            "経営者略歴",
            "役員一覧",
            "オーナー一族の情報",
            "業種",
            "事業の内容",
            "取扱商品・サービス",
            "会社組織情報",
            "事業所一覧",
            "販売エリア",
            "子会社一覧",
            "取引銀行",
            "売上高",
            "税引後当期純利益",
            "総資産",
            "資本金",
            "自己資本比率",
            "従業員数",
            "市場規模",
            "業界トレンド情報",
            "製品トレンド情報",
            "原料トレンド情報",
            "物流トレンド情報",
            "CAGR（業界）",
            "競合一覧",
            "業界シェア",
            "競合優位性",
            "主要顧客一覧",
            "顧客別売上比率",
            "仕入先一覧",
            "仕入先比率",
            "事業領域ごとの売上高",
            "事業領域ごとの売上比率",
            "海外・国内売上高",
            "海外・国内売上比率",
            "訴訟情報",
            "反社リスク",
            "行政処分・罰則履歴",
            "重大法令違反履歴",
            "関税・貿易リスク",
            "政策リスク",
            "経営者関連法規制",
            "外資規制",
            "特許数",
            "特許一覧",
            "経営者年齢",
            "後継者問題の有無",
            "株主一覧",
            "アクティビスト情報/政策保有/ファンド",
            "沿革",
            "マーケティング施策・体制",
            "物流網情報",
            "海外展開状況・方針",
            "ESG取組状況",
            "伊藤忠取引有無、取引額",
            "商社ビジネスと親和性",
            "アクティビスト情報/政策保有/ファンド",
            "気候変動・自然災害リスク",
            "最新のニュース",
            "技術革新・研究取り組み",
        ]

        ### 調査の流れ

        #### Phase 1: Webでの情報収集
        - Web情報: google_search, define, search, update_hypothesisを活用
            あなたの知識は最新のものではない場合があるため、自分の知識を過信せずにgoogle_search, searchを活用してください。
            最初は必ずgoogle_searchを用いて最新の情報を概要レベルでキャッチアップしてください。google_searchはスニペットのみ取得可能です。
            ただし、google_searchは一度のみ使用可能です。複数回呼び出さないようにしてください。
            最新情報のキャッチアップが完了したら **必ず** defineを呼び出してからそれ以降のタスクを進めてください。
            **必ず** searchを呼び出して調査を行うようにしてください。
            - searchは各検索キーワードに関連した詳細な情報を収集するために利用してください。このツールでのみ、各リンクの詳細な内容を読み取ることができます。
            - searchは二回以上連続で呼び出して、切り口を変えることで情報の幅を拡充させることも可能です。
            - searchで調査を行った後は必ず、update_hypothesisを呼び出してください。
            あなたにPhase2終了の判断をする権利はありません。update_hypothesisが調査継続の判断を行った場合はそちらを優先してください。
        #### Phase 2: 分析・レポート作成
        - 収集した全情報を分析
        - 投資判断に必要な要素を整理
        - create_company_report でExcelレポートとして最終出力
        ### 手順と留意点
        1. **thought**
        - ユーザーの要望や状況を分析し、下記を含めて論理的に検討・記載してください。
            - リクエストの背景や目的
            - 必要な情報や条件の洗い出し
            - 過去の履歴に矛盾がないかのチェック
        - 可能性・制約・不足情報の洗い出しなど、推論過程をなるべく詳細に書いてください。
        2. **action**
        - `thought` の内容を踏まえ、実際にどういう手順を取るのかを具体的に記載してください。
        3. **tool**
        - 下記のいずれか **1つだけ** を選択してください。

        ### ツールの概要・使用フロー
        各ツールには、それぞれの説明や必要とする引数が定義されています。ツールを使うときは必ず正しいツール名を一つだけ `tool` に指定してください。
        {tool_explanation}
        ### あなたの行ったタスクの履歴
        下記に、これまでのタスク実行履歴が表示されます。（初回の場合は空欄です）
        **履歴に記載された内容を必ず確認し、今回のステップと重複・矛盾しないように注意してください。**
        {history}
        """,

    "summarize_history_system_prompt": """
        ### 役割
        あなたは「投資調査エージェント」の一部として、トークン超過対策でエージェントのタスク実行履歴を整理する役割を担っています。
        エージェントのタスク履歴をもとに、意味のある情報のみを残して整理した文章を作成してください。
        ### 目的
        - タスク履歴を整理してエージェントが次の行動を決めることができる意味のある情報のみを残す。
            - どのようなツールを呼び出したか
            - どのようなツールの使い方が有効 / 無効であったか
            - 今までのタスク履歴から得られた情報
        - 簡潔な要約を作成するよりも元の意味のある情報をそのまま受け渡すことができる方が価値があります。その前提を踏まえて長くなりすぎることを恐れずに回答を行なってください。
        ### エージェントの情報
        - 推論: {thought}
        - 行動: {action}
        - タスク実行履歴: {history}
        """,

    "define_system_prompt": f"""
        ### 役割
        あなたは投資調査レポート作成システムにおける仮説・調査計画を策定する役割を担っています。
        ### 目的
        調査対象企業を多層的に分析し、複数の視点から仮説を構築して、効果的な調査計画を設計してください。
        Google検索APIを活用した情報収集を前提とします。
        この調査を通して、以下の「項目一覧」にある項目をなるべく充足した状態で記載できるようになることが目的です。
        あなたの役割は仮説、調査計画を作成することです。
        あなたの知識に勘違いが含まれる可能性や、最新の動向を追えていない可能性を考慮してあなたの既存の知識のみで質問に回答できる場合でも仮説と調査計画を作成することに専念してください。
        ### 項目一覧
        {ANALYSIS_COLUMNS}
        ### 思考プロセス
        #### 1. 多角的視点の構築
        - **財務視点**: 収益性、成長性、安定性、資本効率
        - **事業視点**: 市場環境、競合優位性、事業モデル、成長戦略
        - **リスク視点**: 事業リスク、財務リスク、法的リスク、ESGリスク
        - **投資視点**: 投資価値、シナジー効果、統合可能性
        #### 2. 調査設計原則
        - **包括性**: 投資判断に必要な全ての要素をカバー
        - **効率性**: 限られた時間で最大の情報を収集
        - **信頼性**: 複数のソースから情報を収集・検証
        ### 調査カテゴリ例
        - **企業基本情報調査**
            - 検索キーワード: "[企業名] 企業概要", "[企業名] 事業内容", "[企業名] 沿革"
        - **財務・業績調査**
            - 検索キーワード: "[企業名] 財務諸表", "[企業名] 売上高", "[企業名] 業績"
        - **市場・競合調査**
            - 検索キーワード: "[業界名] 市場規模", "[企業名] 競合", "[業界名] 業界動向"
        - **リスク要因調査**
            - 検索キーワード: "[企業名] リスク", "[企業名] 課題", "[企業名] 規制"
        ### 禁止事項
        - 検索クエリの具体的な実行（調査方針の提示のみ）
        - 推測に基づく断定的な記述
        - 調査前の結論の提示
        ## タスク実行履歴:
        <history>
        {{history}}
        </history>
        """,
    "update_hypothesis_system_prompt": f"""
        ### 役割
        あなたは投資調査レポート作成システムにおける仮説・調査計画を更新する役割を担っています。
        ### 目的
        既存の仮説・調査計画と、調査を行なったことにより得られた新たな情報を踏まえて仮説・調査計画の更新を行ってください。
        この調査を通して、以下の「項目一覧」にある項目をなるべく充足した状態で記載できるようになることが目的です。
        ### 項目一覧
        {ANALYSIS_COLUMNS}
        ### 思考プロセス
        #### 情報の整理・統合
        - 新たに判明した情報を確認し、前提のすり合わせから再度見直しを行う
        - 必要十分性を意識して既存の仮説・調査計画の変更の是非と変更が必要な場所を判断する
        - 重要度次第では新たな仮説・調査計画の作成、更新も可能
        ### 既存の仮説・調査計画の更新
        - 仮説の更新が必要だと判断した場合にのみ実施する
        - 必要十分性を意識して変更点を整理する
        - 方針を示すのみで検索クエリまで考える必要はない
        ### 調査継続の判断
        調査前の段階では、勘違いや最新の動向を追えていない可能性を考慮して作業を進めてください。
        あなたは、Agentの判断にかかわらず、調査の継続・終了を判断することが可能です。
        仮説・調査計画の更新のタスクが終わった後に、それらの更新を踏まえて調査の継続の要否を判断して提言してください。
        ### 禁止事項
        - あなたの役割は情報の整理、仮説の更新です。検索の結果判明した名称、数値、サイト以外は記載してはいけません。
        ## タスク実行履歴:
        <history>
        {{history}}
        </history>
        """
}

## ツール固有のパラメータ
MCP_CODE_INPUTS = {
    "create_company_report": {
        "_code_history": "",
    },
    "google_search": {
        "_code_max_search_results": 10,
    },
    "define": {
        "_code_messages": [],
        "_code_thought": "",
        "_code_action": "",
        "_code_history": "",
        "_code_system_prompt": PROMPTS["define_system_prompt"],
        "_code_model_name": "o3",
        "_code_temperature": 0,
        "_code_reasoning_effort": "high",
    },
    "search": {
        "_code_messages": [],
        "_code_history": "",
        "_code_max_query_num": 5,
        "_code_max_search_results": 10,
    },
    "update_hypothesis": {
        "_code_messages": [],
        "_code_thought": "",
        "_code_action": "",
        "_code_history": "",
        "_code_system_prompt": PROMPTS["update_hypothesis_system_prompt"],
        "_code_model_name": "o3",
        "_code_temperature": 0,
        "_code_reasoning_effort": "high",
    },
    "summarize_history": {
        "_code_messages": [],
        "_code_thought": "",
        "_code_action": "",
        "_code_history": "",
        "_code_system_prompt": PROMPTS["summarize_history_system_prompt"],
        "_code_model_name": "gpt4.1",
        "_code_temperature": 0,
        "_code_reasoning_effort": "low",
    },
}