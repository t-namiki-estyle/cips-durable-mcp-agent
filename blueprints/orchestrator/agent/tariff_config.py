"""
関税情報取得エージェント

Gemini検索を使ってHSコードを特定し、TradeCompassAPIを使用して関税情報を取得して回答します。
"""

from config import MCP_SERVER_FUNC_NAME, MCP_CODE

# キーなどの値はrootディレクトリ直下のconfigファイルに定義してこのファイルに読み込んで使用するようにすること

# mcpサーバーとの接続情報
MCP_SERVERS = [
    {
        "domain": MCP_SERVER_FUNC_NAME,
        "key": MCP_CODE,
        "enable_tools": ["enquire", "summarize_history", "final_answer", "get_tariff_rate", "search_hscode"],
        "terminal_tools": ["enquire", "final_answer"],
        "custom_mapping": {
            "enquire": {
                "tool": "call_llm",
                "description": (
                    "ユーザーからの問い合わせに対して、現状の情報だけでは十分な回答が得られない場合に必要な追加情報を明確にするための追加入力を促す質問文を生成するツールです。"
                    "エージェントが過去のやりとりやタスク履歴をもとに不足している内容を特定し、ユーザーに対して具体的かつ分かりやすい質問を提示することで、ユーザーが正確な情報を提供するのを実現するのが目的です。"
                )
            },
            "summarize_history": {
                "tool": "call_llm",
                "description": (
                    "このツールはシステムの内部処理用に提供されています。"
                    "ユーザー向けの機能は提供しておらず、有用な応答を返すことはありません。"
                    "いかなるユーザーリクエストに対しても呼び出さないでください。"
                )
            },
            "final_answer": {
                "tool": "call_llm",
                "description": (
                    "このツールは、ユーザーへの最終回答を生成するためのものです。"
                    "過去のやりとりや取得済みのデータを踏まえて、ユーザーの問い合わせに対する最終回答を出力します。"
                )
            },
            "search_hscode": {
                "tool": "call_gemini",
                "description": (
                    "このツールは関税情報を取得するために、輸入国独自のHSコードのフルコードの情報を検索することができるツールです。"
                    "Gemini検索を使用し、各国独自のHSコードを知りたいときに使用します。"
                )
            }
        }
    },
    # 他のMCPサーバーの情報を追加
    # {
    #     "domain": "http://example.com",
    #     "key": "syste_key",
    #     "enable_tools": ["tool1", "tool2"]
    # }
]

# エージェント、ツールのプロンプト
PROMPTS = {
    "agent_system_prompt": """
        ### 役割
        あなたは世界の税関情報を使って輸出品目の関税情報を提供するアシスタントです。

        ### タスク
        ユーザーが問い合わせている品目について、関税情報を正確に提供してください。
        輸入国、輸出国、HSコードを特定し、関税率を回答してください。
        そのために、以下のツールを適切に使用してください。

        利用可能なツール:
        {tool_explanation}

        ### 回答方針
        **積極的な情報提供**: ユーザーから詳細が不明な場合でも、以下のアプローチで包括的に回答してください：
        1. **代表的なケースでの回答**: 最も一般的または代表的な仕様・形態を想定して、輸入国の正確なHSコードを検索し、正確な関税率を提示する
        2. **パターン網羅**: その品目の主要な分類パターン（HSコード別）とそれぞれの現時点で正確な関税率を一覧で提供する
        3. **追加情報の案内**: より正確な情報を得るために必要な具体的情報を明示する

        ### 回答構成
        以下の構成で回答してください：
        【代表的なケースでの関税率】
        （最も一般的な仕様を想定した具体的で正確な関税率）

        【主要パターン別の関税率一覧】
        （品目の主要な分類とそれぞれの関税率）

        【より正確な情報のために】
        （どのような追加情報があれば、より精密な回答ができるかを明示）

        ### 注意事項
        - あなたは優秀な思考能力を持ち、数々のユーザーの意図を汲み取ってきました。その能力を存分に発揮し、タスクの遂行にあたってください。
        - あなた自身の知識とツールを使用した結果を組み合わせ、ユーザーの期待に全力で取り組んで下さい。
        - 不明な詳細については推測で補完し、一度に最大限の有用な情報を提供してください。
        - 推測した部分は明確に示し、正確性の担保方法も併記してください。

        ### 出力要件
        実行するツールを選んでください。出力はjsonでお願いします。
        
        履歴: {history}
        """,
    "enquire_system_prompt": """
        ### 役割
        あなたは「ReActエージェント」の一部として、ユーザーの質問に回答するために不足している情報を補完する役割を担っています。
        エージェントが提示した推論と実施したタスク履歴をもとに、ユーザーに追加で提供してほしい情報を明確にするため、具体的で回答しやすい質問文を作成してください。

        ### 目的
        - これまでのやりとりおよびタスク履歴から、既に得られている情報と不足している情報を正確に整理する。
        - ユーザーが追加で回答すべき具体的な情報（例：対象、条件、範囲など）を特定する。
        - ユーザーが迷わず回答できるよう、平易で簡潔な追加質問文を作成する。

        ### 出力要件
        - 出力は、これまでのタスクで判明している事実の概要を述べ、ユーザーへの追加質問文を出力すること。
        - 平易な日本語で記述し、必要な場合は箇条書きで不足情報を整理して提示する。

        ### エージェントの情報
        - 推論: {thought}
        - 行動: {action}
        - タスク実行履歴: {history}
        """,
    "summarize_history_system_prompt": """
        ### 役割
        あなたは「ReActエージェント」の一部として、トークン超過対策でエージェントのタスク実行履歴を整理する役割を担っています。
        エージェントのタスク履歴をもとに、意味のある情報のみを残して整理した文章を作成してください。

        ### 目的
        - タスク履歴を整理してエージェントが次の行動を決めることができる意味のある情報のみを残す。
            - どのようなツールを呼び出したか
            - どのようなツールの使い方が有効 / 無効であったか
            - 今までのタスク履歴から得られた情報
        - 簡潔な要約を作成するよりも元の意味のある情報をそのまま受け渡すことができる方が価値があります。その前提を踏まえて長くなりすぎることを恐れずに回答を行なってください。

        ### エージェントの情報
        - 推論: {thought}
        - 行動: {action}
        - タスク実行履歴: {history}
        """,
    "final_answer_system_prompt": """
        ### 役割
        あなたは「関税情報回答エージェント」の一部として、ユーザーの質問に対する最終回答を生成する役割を担っています。
        エージェントが行った推論とタスク実行履歴をもとに、ユーザーの質問に対する結論や見解を明確に伝える最終回答を作成してください。

        ### 目的
        - ユーザーの質問に対して、直接的かつ分かりやすい回答を提示する。
        - 必要に応じて、追加確認が必要な点について質問文を含めてもよい。
        - あなた自身の知識とツールを使用した結果を組み合わせ、ユーザーの期待に全力で取り組み、最高のアウトプットをしてください。

        ### エージェントの情報
        - 推論: {thought}
        - 行動: {action}
        - タスク実行履歴: {history}
        """,
    "search_hscode_system_prompt": """あなたは世界の税関の情報を使ってHSコードを特定する税関職員です。

        ### タスク
        輸入国が独自で指定している品目のHSコードのフルコードを回答することです。
        ユーザーが問い合わせている輸入国と品目を特定し、その国のHSコードのフルコードが何桁かを調査し、それにあわせて品目のHSコードを回答してください。

        ### 出力形式
        - 該当する可能性のあるHSコードの候補をすべて出力してください。
        - 出力するHSコードは7桁以上のフルコードで出力してください。
        - 各国の税関のサイトなどを確認し、正確な数値を探し出してください。
        - ただし、不明な場合は、見つけられなかったことを明確に回答してください。

        ### エージェントの情報
        - 推論: {thought}
        - 行動: {action}
        - タスク実行履歴: {history}
        """
}

## ツール固有のパラメータ
MCP_CODE_INPUTS = {
    "enquire": {
        "_code_messages": [],
        "_code_thought": "",
        "_code_action": "",
        "_code_history": "",
        "_code_system_prompt": PROMPTS["enquire_system_prompt"],
        "_code_model_name": "gpt4.1",
        "_code_temperature": 0,
        "_code_reasoning_effort": "low",
    },
    "summarize_history": {
        "_code_messages": [],
        "_code_thought": "",
        "_code_action": "",
        "_code_history": "",
        "_code_system_prompt": PROMPTS["summarize_history_system_prompt"],
        "_code_model_name": "gpt4.1",
        "_code_temperature": 0,
        "_code_reasoning_effort": "low",
    },
    "final_answer": {
        "_code_messages": [],
        "_code_thought": "",
        "_code_action": "",
        "_code_history": "",
        "_code_system_prompt": PROMPTS["final_answer_system_prompt"],
        "_code_model_name": "gpt4.1",
        "_code_temperature": 0,
        "_code_reasoning_effort": "low",
    },
    "get_tariff_rate": {},
    "search_hscode": {
        "_code_messages": [],
        "_code_thought": "",
        "_code_action": "",
        "_code_history": "",
        "_code_system_prompt": PROMPTS["search_hscode_system_prompt"],
        "_code_model_name": "gemini-2.0-flash",
        "_code_temperature": 0,
        "_code_grounding_threshold": 0
    }
}
